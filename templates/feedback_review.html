{% extends "streamlined_base.html" %}

{% block title %}Review Feedback - PRISM Alpha{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 text-primary mb-3">
                    <i class="fas fa-clipboard-list me-3"></i>Feedback Review
                </h1>
                <p class="lead text-muted">
                    Review and manage user feedback submissions
                </p>
            </div>

            <!-- Summary Statistics -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card border-primary h-100">
                        <div class="card-body text-center">
                            <h2 class="display-4 text-primary mb-0">{{ total_count }}</h2>
                            <p class="text-muted mb-0">Total Submissions</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-info h-100">
                        <div class="card-body text-center">
                            <h2 class="display-4 text-info mb-0">{{ status_counts.new }}</h2>
                            <p class="text-muted mb-0">New</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-warning h-100">
                        <div class="card-body text-center">
                            <h2 class="display-4 text-warning mb-0">{{ status_counts.reviewed }}</h2>
                            <p class="text-muted mb-0">Reviewed</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-success h-100">
                        <div class="card-body text-center">
                            <h2 class="display-4 text-success mb-0">{{ status_counts.addressed }}</h2>
                            <p class="text-muted mb-0">Addressed</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category Breakdown -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Feedback by Category
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for category, count in category_counts.items() %}
                        <div class="col-md-4 col-sm-6 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-secondary">{{ category or "Uncategorized" }}</span>
                                <span class="text-muted">{{ count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="mb-4 d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="exportToCSV()">
                    <i class="fas fa-download me-2"></i>Export to CSV
                </button>
                <button class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Print
                </button>
            </div>

            <!-- Feedback Items -->
            {% if feedback_items %}
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>All Feedback Submissions
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for item in feedback_items %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between mb-2">
                                <h6 class="mb-1">
                                    <span class="badge bg-{{ 'info' if item.status == 'new' else 'warning' if item.status == 'reviewed' else 'success' }}">
                                        {{ item.status|upper }}
                                    </span>
                                    <span class="badge bg-secondary ms-2">{{ item.category or "Uncategorized" }}</span>
                                </h6>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ item.submitted_at.strftime('%Y-%m-%d %H:%M') }}
                                </small>
                            </div>

                            <div class="mb-2">
                                <strong>Feedback:</strong>
                                <p class="mb-0 mt-1" style="white-space: pre-wrap;">{{ item.feedback_text }}</p>
                            </div>

                            {% if item.page_url %}
                            <div class="small text-muted mb-2">
                                <i class="fas fa-link me-1"></i>
                                <strong>Page:</strong> {{ item.page_url }}
                            </div>
                            {% endif %}

                            {% if item.contact_name or item.contact_email %}
                            <div class="small text-muted mb-2">
                                <i class="fas fa-user me-1"></i>
                                <strong>Contact:</strong>
                                {% if item.contact_name %}{{ item.contact_name }}{% endif %}
                                {% if item.contact_email %}
                                    {% if item.contact_name %} - {% endif %}
                                    <a href="mailto:{{ item.contact_email }}">{{ item.contact_email }}</a>
                                {% endif %}
                            </div>
                            {% endif %}

                            {% if item.user_agent %}
                            <details class="small text-muted">
                                <summary style="cursor: pointer;">Technical Details</summary>
                                <div class="mt-2">
                                    <strong>ID:</strong> {{ item.id }}<br>
                                    <strong>User Agent:</strong> {{ item.user_agent }}
                                </div>
                            </details>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No feedback submissions yet. Share the feedback page with users to start collecting input.
            </div>
            {% endif %}

            <!-- Back Button -->
            <div class="mt-4">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Home
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function exportToCSV() {
    // Create CSV content
    let csv = 'ID,Status,Category,Submitted At,Feedback Text,Page URL,Contact Name,Contact Email,User Agent\n';

    {% for item in feedback_items %}
    csv += [
        {{ item.id }},
        "{{ item.status }}",
        "{{ item.category or '' }}",
        "{{ item.submitted_at.strftime('%Y-%m-%d %H:%M:%S') }}",
        "{{ item.feedback_text|replace('"', '""')|replace('\n', ' ') }}",
        "{{ item.page_url or '' }}",
        "{{ item.contact_name or '' }}",
        "{{ item.contact_email or '' }}",
        "{{ item.user_agent or '' }}"
    ].map(field => `"${field}"`).join(',') + '\n';
    {% endfor %}

    // Create download link
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'prism_feedback_{{ total_count }}_submissions.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}

{% extends "streamlined_base.html" %}

{% block title %}Edit Interaction{% endblock %}

{% block content %}
<h1 class="text-center mb-4">
    <i class="fas fa-edit me-2"></i>Curate Tool Interaction
</h1>
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="alert alert-info border-0 mb-4">
                    <h6 class="alert-heading">
                        <i class="fas fa-info-circle me-2"></i>Curation Mode
                    </h6>
                    <p class="mb-0 small">
                        You are editing interaction #{{ interaction.id }}. Changes will update the existing record.
                    </p>
                </div>
                
                <form method="POST" action="{{ url_for('edit_interaction', interaction_id=interaction.id) }}">
                    
                    <!-- Core Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="source_tool_id" class="form-label">Source Tool</label>
                            <select class="form-select" id="source_tool_id" name="source_tool_id" required>
                                <option value="">Select a source tool...</option>
                                {% for tool in tools %}
                                <option value="{{ tool.id }}" data-stage="{{ tool.category.stage.name }}" 
                                        {% if tool.id == interaction.source_tool_id %}selected{% endif %}>
                                    {{ tool.name }} ({{ tool.category.stage.name }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="target_tool_id" class="form-label">Target Tool</label>
                            <select class="form-select" id="target_tool_id" name="target_tool_id" required>
                                <option value="">Select a target tool...</option>
                                {% for tool in tools %}
                                <option value="{{ tool.id }}" data-stage="{{ tool.category.stage.name }}"
                                        {% if tool.id == interaction.target_tool_id %}selected{% endif %}>
                                    {{ tool.name }} ({{ tool.category.stage.name }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="interaction_type" class="form-label">Interaction Type</label>
                            <select class="form-select" id="interaction_type" name="interaction_type" required>
                                <option value="">Select interaction type...</option>
                                {% for interaction_type in interaction_types %}
                                <option value="{{ interaction_type }}" 
                                        {% if interaction_type == interaction.interaction_type %}selected{% endif %}>
                                    {{ interaction_type }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="lifecycle_stage" class="form-label">Lifecycle Stage</label>
                            <select class="form-select" id="lifecycle_stage" name="lifecycle_stage" required>
                                <option value="">Select a lifecycle stage...</option>
                                {% for stage in stages %}
                                <option value="{{ stage.name }}" 
                                        {% if stage.name == interaction.lifecycle_stage %}selected{% endif %}>
                                    {{ stage.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" 
                                  placeholder="Describe the interaction in detail." required>{{ interaction.description or '' }}</textarea>
                    </div>

                    <!-- Technical Details -->
                    <h5 class="mt-4">Technical Details</h5>
                    <div class="mb-3">
                        <label for="technical_details" class="form-label">Technical Implementation</label>
                        <textarea class="form-control" id="technical_details" name="technical_details" rows="2" 
                                  placeholder="e.g., REST API, OAuth 2.0">{{ interaction.technical_details or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="benefits" class="form-label">Benefits</label>
                        <textarea class="form-control" id="benefits" name="benefits" rows="2" 
                                  placeholder="Advantages of this interaction">{{ interaction.benefits or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="challenges" class="form-label">Challenges</label>
                        <textarea class="form-control" id="challenges" name="challenges" rows="2" 
                                  placeholder="Limitations or difficulties">{{ interaction.challenges or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="examples" class="form-label">Examples</label>
                        <textarea class="form-control" id="examples" name="examples" rows="2" 
                                  placeholder="Real-world examples">{{ interaction.examples or '' }}</textarea>
                    </div>

                    <!-- Contact Information -->
                    <h5 class="mt-4">Contact Information</h5>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="contact_person" class="form-label">Contact Person</label>
                            <input type="text" class="form-control" id="contact_person" name="contact_person" 
                                   value="{{ interaction.contact_person or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="organization" class="form-label">Organization</label>
                            <input type="text" class="form-control" id="organization" name="organization" 
                                   value="{{ interaction.organization or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" 
                                   value="{{ interaction.email or '' }}">
                        </div>
                    </div>

                    <!-- Classification -->
                    <h5 class="mt-4">Classification</h5>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="priority" class="form-label">Priority</label>
                            <select class="form-select" id="priority" name="priority">
                                <option value="">Select...</option>
                                <option value="high" {% if interaction.priority == 'high' %}selected{% endif %}>High</option>
                                <option value="medium" {% if interaction.priority == 'medium' %}selected{% endif %}>Medium</option>
                                <option value="low" {% if interaction.priority == 'low' %}selected{% endif %}>Low</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="complexity" class="form-label">Complexity</label>
                            <select class="form-select" id="complexity" name="complexity">
                                <option value="">Select...</option>
                                <option value="simple" {% if interaction.complexity == 'simple' %}selected{% endif %}>Simple</option>
                                <option value="moderate" {% if interaction.complexity == 'moderate' %}selected{% endif %}>Moderate</option>
                                <option value="complex" {% if interaction.complexity == 'complex' %}selected{% endif %}>Complex</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">Select...</option>
                                <option value="proposed" {% if interaction.status == 'proposed' %}selected{% endif %}>Proposed</option>
                                <option value="pilot" {% if interaction.status == 'pilot' %}selected{% endif %}>Pilot</option>
                                <option value="implemented" {% if interaction.status == 'implemented' %}selected{% endif %}>Implemented</option>
                                <option value="deprecated" {% if interaction.status == 'deprecated' %}selected{% endif %}>Deprecated</option>
                            </select>
                        </div>
                    </div>

                    <!-- Submitter -->
                    <div class="mb-3">
                        <label for="submitted_by" class="form-label">Submitted By</label>
                        <input type="text" class="form-control" id="submitted_by" name="submitted_by" 
                               placeholder="Enter name or affiliation" value="{{ interaction.submitted_by or '' }}">
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-save me-2"></i>Update Interaction
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid">
                                <a href="{{ url_for('interaction_detail', interaction_id=interaction.id) }}" 
                                   class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </a>
                            </div>
                        </div>
                    </div>
                    
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sourceToolSelect = document.getElementById('source_tool_id');
    const targetToolSelect = document.getElementById('target_tool_id');
    const lifecycleStageSelect = document.getElementById('lifecycle_stage');
    
    function updateLifecycleStage() {
        const sourceOption = sourceToolSelect.options[sourceToolSelect.selectedIndex];
        const targetOption = targetToolSelect.options[targetToolSelect.selectedIndex];
        
        if (sourceOption && sourceOption.dataset.stage && targetOption && targetOption.dataset.stage) {
            const sourceStage = sourceOption.dataset.stage;
            const targetStage = targetOption.dataset.stage;
            
            // If both tools are from the same stage, select that stage
            if (sourceStage === targetStage) {
                lifecycleStageSelect.value = sourceStage;
            } else {
                // If tools are from different stages, prioritize the source tool's stage
                lifecycleStageSelect.value = sourceStage;
            }
        } else if (sourceOption && sourceOption.dataset.stage) {
            // If only source tool is selected, use its stage
            lifecycleStageSelect.value = sourceOption.dataset.stage;
        } else if (targetOption && targetOption.dataset.stage) {
            // If only target tool is selected, use its stage
            lifecycleStageSelect.value = targetOption.dataset.stage;
        }
    }
    
    // Add event listeners to both tool selects (only if not already set)
    if (!lifecycleStageSelect.value || lifecycleStageSelect.value === "") {
        sourceToolSelect.addEventListener('change', updateLifecycleStage);
        targetToolSelect.addEventListener('change', updateLifecycleStage);
    }
});
</script>

{% endblock %}
{% extends "streamlined_base.html" %}

{% block title %}View All Interactions{% endblock %}

{% block content %}
<h1 class="text-center mb-4">All Tool Interactions</h1>

<!-- Search and Filter Controls -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="fas fa-filter me-2"></i>Search & Filter Interactions
        </h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <!-- Text Search -->
            <div class="col-md-4">
                <label for="search-input" class="form-label">
                    Search
                    <span class="text-muted ms-1"
                          data-bs-toggle="tooltip"
                          title="Search tool names, descriptions, and technical details">
                        <i class="fas fa-question-circle"></i>
                    </span>
                </label>
                <input type="text" class="form-control" id="search-input"
                       placeholder="Search by tool name, description...">
            </div>

            <!-- Interaction Type Filter -->
            <div class="col-md-3">
                <label for="filter-type" class="form-label">Interaction Type</label>
                <select class="form-select" id="filter-type">
                    <option value="">All Types</option>
                    {% for interaction_type in interaction_types %}
                    <option value="{{ interaction_type }}">{{ interaction_type }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Lifecycle Stage Filter -->
            <div class="col-md-3">
                <label for="filter-stage" class="form-label">Lifecycle Stage</label>
                <select class="form-select" id="filter-stage">
                    <option value="">All Stages</option>
                    {% for stage in stages %}
                    <option value="{{ stage.name }}">{{ stage.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Clear Button -->
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100" id="clear-filters">
                    <i class="fas fa-times me-1"></i>Clear Filters
                </button>
            </div>
        </div>

        <!-- Advanced Filters (Collapsible) -->
        <div class="mt-3">
            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                <i class="fas fa-sliders-h me-1"></i>Advanced Filters
            </button>
        </div>

        <div class="collapse mt-3" id="advancedFilters">
            <div class="row g-3">
                <!-- Priority Filter -->
                <div class="col-md-3">
                    <label for="filter-priority" class="form-label">Priority</label>
                    <select class="form-select" id="filter-priority">
                        <option value="">All Priorities</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>

                <!-- Complexity Filter -->
                <div class="col-md-3">
                    <label for="filter-complexity" class="form-label">Complexity</label>
                    <select class="form-select" id="filter-complexity">
                        <option value="">All Complexities</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="col-md-3">
                    <label for="filter-status" class="form-label">Status</label>
                    <select class="form-select" id="filter-status">
                        <option value="">All Statuses</option>
                        <option value="Active">Active</option>
                        <option value="Planned">Planned</option>
                        <option value="Deprecated">Deprecated</option>
                    </select>
                </div>

                <!-- Organization Filter -->
                <div class="col-md-3">
                    <label for="filter-organization" class="form-label">Organization</label>
                    <input type="text" class="form-control" id="filter-organization" placeholder="Filter by organization...">
                </div>
            </div>
        </div>

        <!-- Results Count -->
        <div class="mt-3">
            <div class="alert alert-info border-0 mb-0 py-2" id="result-count-alert">
                <small id="result-count">Loading interactions...</small>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Source Tool</th>
                        <th>Target Tool</th>
                        <th>Interaction Type</th>
                        <th>Lifecycle Stage</th>
                        <th>Description</th>
                        <th>Submitted At</th>
                        <th width="80">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for interaction in interactions %}
                    <tr>
                        <td>
                            {{ interaction.source_tool.name }}
                            {% if interaction.source_tool.is_open_source %}
                            <span class="badge bg-success ms-1" title="Open Source">
                                <i class="fas fa-code-branch"></i> OS
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {{ interaction.target_tool.name }}
                            {% if interaction.target_tool.is_open_source %}
                            <span class="badge bg-success ms-1" title="Open Source">
                                <i class="fas fa-code-branch"></i> OS
                            </span>
                            {% endif %}
                        </td>
                        <td>{{ interaction.interaction_type }}</td>
                        <td>{{ interaction.lifecycle_stage }}</td>
                        <td>{{ interaction.description }}</td>
                        <td>{{ interaction.submitted_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('interaction_detail', interaction_id=interaction.id) }}" 
                                   class="btn btn-outline-primary btn-sm" title="View details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('edit_interaction', interaction_id=interaction.id) }}" 
                                   class="btn btn-outline-secondary btn-sm" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center">No interactions found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="text-center mt-4">
    <a href="{{ url_for('add_interaction') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Add New Interaction
    </a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all filter elements
    const searchInput = document.getElementById('search-input');
    const filterType = document.getElementById('filter-type');
    const filterStage = document.getElementById('filter-stage');
    const filterPriority = document.getElementById('filter-priority');
    const filterComplexity = document.getElementById('filter-complexity');
    const filterStatus = document.getElementById('filter-status');
    const filterOrganization = document.getElementById('filter-organization');
    const clearButton = document.getElementById('clear-filters');
    const resultCountElement = document.getElementById('result-count');

    // Get all table rows (excluding header)
    const tableRows = document.querySelectorAll('tbody tr');
    const totalRows = tableRows.length;

    /**
     * Main filter function - applies all active filters
     */
    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedType = filterType.value.toLowerCase();
        const selectedStage = filterStage.value.toLowerCase();
        const selectedPriority = filterPriority.value.toLowerCase();
        const selectedComplexity = filterComplexity.value.toLowerCase();
        const selectedStatus = filterStatus.value.toLowerCase();
        const selectedOrganization = filterOrganization.value.toLowerCase().trim();

        let visibleCount = 0;

        tableRows.forEach(row => {
            // Get row text content for searching
            const rowText = row.textContent.toLowerCase();

            // Apply search filter
            const matchesSearch = !searchTerm || rowText.includes(searchTerm);

            // Apply interaction type filter
            const matchesType = !selectedType || rowText.includes(selectedType);

            // Apply lifecycle stage filter
            const matchesStage = !selectedStage || rowText.includes(selectedStage);

            // Apply priority filter
            const matchesPriority = !selectedPriority || rowText.includes(selectedPriority);

            // Apply complexity filter
            const matchesComplexity = !selectedComplexity || rowText.includes(selectedComplexity);

            // Apply status filter
            const matchesStatus = !selectedStatus || rowText.includes(selectedStatus);

            // Apply organization filter
            const matchesOrganization = !selectedOrganization || rowText.includes(selectedOrganization);

            // Show row only if all filters match
            if (matchesSearch && matchesType && matchesStage && matchesPriority &&
                matchesComplexity && matchesStatus && matchesOrganization) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Update result count
        updateResultCount(visibleCount, totalRows);
    }

    /**
     * Update the result count display
     */
    function updateResultCount(visible, total) {
        if (visible === total) {
            resultCountElement.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                Showing all <strong>${total}</strong> interaction(s)
            `;
            document.getElementById('result-count-alert').className = 'alert alert-info border-0 mb-0 py-2';
        } else {
            resultCountElement.innerHTML = `
                <i class="fas fa-filter me-2"></i>
                Showing <strong>${visible}</strong> of <strong>${total}</strong> interaction(s)
            `;
            document.getElementById('result-count-alert').className = 'alert alert-success border-0 mb-0 py-2';
        }
    }

    /**
     * Clear all filters and show all rows
     */
    function clearFilters() {
        searchInput.value = '';
        filterType.value = '';
        filterStage.value = '';
        filterPriority.value = '';
        filterComplexity.value = '';
        filterStatus.value = '';
        filterOrganization.value = '';
        filterTable();
    }

    // Event listeners
    searchInput.addEventListener('keyup', filterTable);
    searchInput.addEventListener('search', filterTable); // For search input clear button
    filterType.addEventListener('change', filterTable);
    filterStage.addEventListener('change', filterTable);
    filterPriority.addEventListener('change', filterTable);
    filterComplexity.addEventListener('change', filterTable);
    filterStatus.addEventListener('change', filterTable);
    filterOrganization.addEventListener('keyup', filterTable);
    clearButton.addEventListener('click', clearFilters);

    // Initialize count on page load
    updateResultCount(totalRows, totalRows);

    // Persist filters across page navigation
    // Save filter state to sessionStorage
    function saveFilterState() {
        sessionStorage.setItem('prism_search', searchInput.value);
        sessionStorage.setItem('prism_filter_type', filterType.value);
        sessionStorage.setItem('prism_filter_stage', filterStage.value);
        sessionStorage.setItem('prism_filter_priority', filterPriority.value);
        sessionStorage.setItem('prism_filter_complexity', filterComplexity.value);
        sessionStorage.setItem('prism_filter_status', filterStatus.value);
        sessionStorage.setItem('prism_filter_organization', filterOrganization.value);
    }

    // Restore filter state on page load
    function restoreFilterState() {
        const savedSearch = sessionStorage.getItem('prism_search');
        const savedType = sessionStorage.getItem('prism_filter_type');
        const savedStage = sessionStorage.getItem('prism_filter_stage');
        const savedPriority = sessionStorage.getItem('prism_filter_priority');
        const savedComplexity = sessionStorage.getItem('prism_filter_complexity');
        const savedStatus = sessionStorage.getItem('prism_filter_status');
        const savedOrganization = sessionStorage.getItem('prism_filter_organization');

        if (savedSearch) searchInput.value = savedSearch;
        if (savedType) filterType.value = savedType;
        if (savedStage) filterStage.value = savedStage;
        if (savedPriority) filterPriority.value = savedPriority;
        if (savedComplexity) filterComplexity.value = savedComplexity;
        if (savedStatus) filterStatus.value = savedStatus;
        if (savedOrganization) filterOrganization.value = savedOrganization;

        // Apply restored filters and expand advanced section if any advanced filters are active
        if (savedSearch || savedType || savedStage || savedPriority || savedComplexity || savedStatus || savedOrganization) {
            if (savedPriority || savedComplexity || savedStatus || savedOrganization) {
                // Show advanced filters if any are set
                const advancedCollapse = document.getElementById('advancedFilters');
                if (advancedCollapse) {
                    advancedCollapse.classList.add('show');
                }
            }
            filterTable();
        }
    }

    // Restore previous filters
    restoreFilterState();

    // Save filters when they change
    searchInput.addEventListener('change', saveFilterState);
    filterType.addEventListener('change', saveFilterState);
    filterStage.addEventListener('change', saveFilterState);
    filterPriority.addEventListener('change', saveFilterState);
    filterComplexity.addEventListener('change', saveFilterState);
    filterStatus.addEventListener('change', saveFilterState);
    filterOrganization.addEventListener('change', saveFilterState);

    // Clear saved state when clearing filters
    clearButton.addEventListener('click', function() {
        sessionStorage.removeItem('prism_search');
        sessionStorage.removeItem('prism_filter_type');
        sessionStorage.removeItem('prism_filter_stage');
        sessionStorage.removeItem('prism_filter_priority');
        sessionStorage.removeItem('prism_filter_complexity');
        sessionStorage.removeItem('prism_filter_status');
        sessionStorage.removeItem('prism_filter_organization');
    });
});
</script>
{% endblock %}

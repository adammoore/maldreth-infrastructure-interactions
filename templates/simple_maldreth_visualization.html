{% extends "streamlined_base.html" %}

{% block title %}MaLDReTH Official Visualization - PRISM | MaLDReTH II RDA{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-primary mb-3">
                <i class="fas fa-project-diagram me-3"></i>MaLDReTH Research Data Lifecycle
            </h1>
            <p class="lead text-muted">
                Official visualization based on MaLDReTH deliverables showing the 12-stage research data lifecycle with tool mapping
            </p>
            <div class="alert alert-info">
                <small><i class="fas fa-info-circle me-2"></i>
                Based on MaLDReTH Deliverable D2.1 and D3.1 specifications - Circular lifecycle model with interconnected stages
                </small>
            </div>
        </div>
    </div>

    <!-- MaLDReTH Stacked Nested Visualization -->
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="stacked-lifecycle-container">
                <div class="lifecycle-header mb-4">
                    <h3 class="text-center text-white mb-0">MaLDReTH Research Data Lifecycle</h3>
                    <p class="text-center text-light mb-0">Interactive nested visualization - click stages to expand categories and tools</p>
                    
                    <!-- Interactive Controls -->
                    <div class="text-center mt-3">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-light btn-sm" onclick="resetVisualization()">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="expandAllCategories()">
                                <i class="fas fa-expand-arrows-alt me-1"></i>Show All Categories
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="expandAllTools()">
                                <i class="fas fa-tools me-1"></i>Show All Tools
                            </button>
                        </div>
                    </div>
                </div>
                
                {% for stage in stages %}
                {% set stage_color = '#90C695' if stage.name in ['CONCEPTUALISE', 'PLAN', 'COLLECT', 'PROCESS', 'ANALYSE', 'STORE'] else '#7FB3D3' %}
                {% set stage_color = '#4A90A4' if stage.name == 'FUND' else stage_color %}
                
                <div class="stage-stack-container mb-3" data-stage-id="{{ stage.id }}">
                    <!-- Stage Header - Clickable -->
                    <div class="stage-header clickable" style="background-color: {{ stage_color }};" onclick="toggleStageExpansion({{ stage.id }})">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="stage-number me-3">{{ stage.position + 1 }}</div>
                                <div>
                                    <h5 class="mb-0 text-white">{{ stage.name.title() }} <i class="fas fa-chevron-down expand-icon ms-2"></i></h5>
                                    <small class="text-light">{{ stage.description[:50] if stage.description else 'Research data lifecycle stage' }}...</small>
                                </div>
                            </div>
                            <div class="stage-stats text-white">
                                <span class="badge bg-light text-dark me-2">
                                    {% set stage_data = visualization_data.stages | selectattr('id', 'equalto', stage.id) | first %}
                                    {{ stage_data.tool_count if stage_data else 0 }} tools
                                </span>
                                <span class="badge bg-light text-dark">{{ stage.tool_categories.count() }} categories</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Categories and Tools Nested Structure -->
                    <div class="expandable-content" id="stage-content-{{ stage.id }}" style="display: none;">
                        {% if stage.tool_categories %}
                        <div class="categories-container">
                            {% for category in stage.tool_categories %}
                            <div class="category-row" data-category-id="{{ category.id }}">
                                <div class="category-header clickable" onclick="toggleCategoryExpansion({{ category.id }})">
                                    <div class="category-connector"></div>
                                    <div class="category-name">
                                        {{ category.name }}
                                        <i class="fas fa-chevron-down category-expand-icon ms-2"></i>
                                        <small class="text-muted ms-2">({{ category.tools.count() }} tools)</small>
                                    </div>
                                </div>
                                <div class="tools-grid expandable-tools" id="category-tools-{{ category.id }}" style="display: none;">
                                    {% for tool in category.tools if tool.is_active %}
                                    <div class="tool-item" title="{{ tool.description if tool.description else tool.name }}">
                                        {{ tool.name }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="no-categories">
                            <em class="text-muted">No categories defined for this stage</em>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Flow Arrow to Next Stage -->
                    {% if not loop.last and stage.name != 'TRANSFORM' %}
                    <div class="flow-arrow">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    {% elif stage.name == 'TRANSFORM' %}
                    <div class="flow-arrow-back">
                        <i class="fas fa-arrow-up"></i>
                        <small class="text-muted">Back to Conceptualise</small>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                
            </div>
        </div>
    </div>

    <!-- Stage Details Table -->
    <div class="row mt-4">
        <div class="col-12">
            <h3 class="text-primary mb-3">Research Data Lifecycle Stages</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Stage</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Tools</th>
                            <th>Categories</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set stage_colors = ['#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4'] %}
                        {% for stage in stages %}
                        {% set color = stage_colors[loop.index0 % stage_colors|length] %}
                        <tr style="border-left: 4px solid {{ color }};">
                            <td>
                                <span class="badge rounded-pill" style="background-color: {{ color }};">
                                    {{ stage.position + 1 }}
                                </span>
                            </td>
                            <td><strong>{{ stage.name }}</strong></td>
                            <td>{{ stage.description[:100] if stage.description else "Research data lifecycle stage" }}...</td>
                            <td>
                                {% set stage_data = visualization_data.stages | selectattr('id', 'equalto', stage.id) | first %}
                                <span class="badge bg-primary">{{ stage_data.tool_count if stage_data else 0 }}</span>
                            </td>
                            <td>
                                {% set categories = stage.tool_categories %}
                                <span class="badge bg-secondary">{{ categories.count() if categories else 0 }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tool Categories by Stage -->
    <div class="row mt-4">
        <div class="col-12">
            <h3 class="text-primary mb-3">Tool Categories by Lifecycle Stage</h3>
            <div class="row">
                {% set stage_colors = ['#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4'] %}
                {% for stage in stages %}
                {% if stage.tool_categories %}
                {% set color = stage_colors[loop.index0 % stage_colors|length] %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100" style="border-left: 4px solid {{ color }};">
                        <div class="card-header" style="background-color: {{ color }}20;">
                            <h6 class="mb-0" style="color: {{ color }};">
                                <strong>{{ stage.position + 1 }}. {{ stage.name }}</strong>
                            </h6>
                        </div>
                        <div class="card-body">
                            {% for category in stage.tool_categories %}
                            <div class="mb-2">
                                <small class="fw-bold">{{ category.name }}</small>
                                <br>
                                <small class="text-muted">{{ category.tools.count() }} tools</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced JavaScript for MaLDReTH interactivity
function focusStage(stageName, stageNumber, toolCount) {
    const message = `MaLDReTH Stage ${stageNumber}: ${stageName}\n\nTools Available: ${toolCount}\n\nThis represents the ${stageName.toLowerCase()} phase of the research data lifecycle.\n\nBased on MaLDReTH deliverable specifications for comprehensive tool mapping.`;
    alert(message);
    
    // Highlight connected stages (simplified version of official interconnections)
    highlightStageConnections(stageNumber);
}

function highlightStageConnections(stageNumber) {
    // Remove any existing highlights
    document.querySelectorAll('.stage-highlight').forEach(el => el.classList.remove('stage-highlight'));
    
    // Add highlight class to current stage
    const currentStage = document.querySelector(`[onclick*="focusStage"][onclick*="${stageNumber}"]`);
    if (currentStage) {
        currentStage.classList.add('stage-highlight');
        
        // Remove highlight after 3 seconds
        setTimeout(() => {
            currentStage.classList.remove('stage-highlight');
        }, 3000);
    }
}

// Interactive Stacked Visualization Functions
function toggleStageExpansion(stageId) {
    const stageContainer = document.querySelector(`[data-stage-id="${stageId}"]`);
    const contentElement = document.getElementById(`stage-content-${stageId}`);
    const expandIcon = stageContainer.querySelector('.expand-icon');
    
    if (contentElement.style.display === 'none' || contentElement.style.display === '') {
        contentElement.style.display = 'block';
        stageContainer.classList.add('expanded');
        expandIcon.classList.add('expanded');
    } else {
        contentElement.style.display = 'none';
        stageContainer.classList.remove('expanded');
        expandIcon.classList.remove('expanded');
        
        // Also collapse all categories in this stage
        const categories = contentElement.querySelectorAll('.expandable-tools');
        categories.forEach(cat => cat.style.display = 'none');
        const categoryIcons = contentElement.querySelectorAll('.category-expand-icon');
        categoryIcons.forEach(icon => icon.classList.remove('expanded'));
    }
}

function toggleCategoryExpansion(categoryId) {
    const toolsElement = document.getElementById(`category-tools-${categoryId}`);
    const categoryRow = document.querySelector(`[data-category-id="${categoryId}"]`);
    const expandIcon = categoryRow.querySelector('.category-expand-icon');
    
    if (toolsElement.style.display === 'none' || toolsElement.style.display === '') {
        toolsElement.style.display = 'flex';
        expandIcon.classList.add('expanded');
    } else {
        toolsElement.style.display = 'none';
        expandIcon.classList.remove('expanded');
    }
}

function resetVisualization() {
    // Collapse all stages
    document.querySelectorAll('.expandable-content').forEach(content => {
        content.style.display = 'none';
    });
    
    // Collapse all categories
    document.querySelectorAll('.expandable-tools').forEach(tools => {
        tools.style.display = 'none';
    });
    
    // Reset all expand icons
    document.querySelectorAll('.expand-icon, .category-expand-icon').forEach(icon => {
        icon.classList.remove('expanded');
    });
    
    // Reset stage containers
    document.querySelectorAll('.stage-stack-container').forEach(container => {
        container.classList.remove('expanded');
    });
}

function expandAllCategories() {
    // Show all stage content
    document.querySelectorAll('.expandable-content').forEach(content => {
        content.style.display = 'block';
    });
    
    // Mark all stages as expanded
    document.querySelectorAll('.stage-stack-container').forEach(container => {
        container.classList.add('expanded');
    });
    
    // Show all stage expand icons as expanded
    document.querySelectorAll('.expand-icon').forEach(icon => {
        icon.classList.add('expanded');
    });
    
    // Keep tools collapsed
    document.querySelectorAll('.expandable-tools').forEach(tools => {
        tools.style.display = 'none';
    });
    
    document.querySelectorAll('.category-expand-icon').forEach(icon => {
        icon.classList.remove('expanded');
    });
}

function expandAllTools() {
    // Show all stage content and categories
    expandAllCategories();
    
    // Show all tools
    document.querySelectorAll('.expandable-tools').forEach(tools => {
        tools.style.display = 'flex';
    });
    
    // Show all category expand icons as expanded
    document.querySelectorAll('.category-expand-icon').forEach(icon => {
        icon.classList.add('expanded');
    });
}

// Add CSS filters for mathematical functions (fallback)
if (typeof Math.cos === 'undefined') {
    // Fallback positions if trigonometry isn't available
    console.log('Using fallback positioning');
}
</script>

<!-- Custom CSS for MaLDReTH Stacked Visualization -->
<style>
/* Stacked Lifecycle Container */
.stacked-lifecycle-container {
    background: linear-gradient(135deg, #2C3E50 0%, #3498DB 30%, #9B59B6 70%, #E74C3C 100%);
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.lifecycle-header {
    text-align: center;
    margin-bottom: 2rem;
}

/* Stage Stack Styling */
.stage-stack-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.stage-stack-container.expanded {
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.stage-header {
    padding: 1rem 1.5rem;
    border-left: 5px solid rgba(255, 255, 255, 0.3);
    transition: all 0.3s ease;
}

.clickable {
    cursor: pointer;
    transition: all 0.3s ease;
}

.clickable:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.expand-icon, .category-expand-icon {
    transition: transform 0.3s ease;
    font-size: 12px;
}

.expand-icon.expanded, .category-expand-icon.expanded {
    transform: rotate(180deg);
}

.stage-number {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
}

/* Categories Container */
.categories-container {
    background: #f8f9fa;
    padding: 0;
}

.category-row {
    border-bottom: 1px solid #e9ecef;
    padding: 0;
}

.category-row:last-child {
    border-bottom: none;
}

.category-header {
    background: #e9ecef;
    padding: 0.75rem 1.5rem;
    display: flex;
    align-items: center;
    border-left: 3px solid #6c757d;
    transition: background-color 0.3s ease;
}

.category-header:hover {
    background: #dee2e6;
}

.expandable-content {
    animation: slideDown 0.3s ease-out;
}

.expandable-tools {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}

.category-connector {
    width: 20px;
    height: 2px;
    background: #6c757d;
    margin-right: 10px;
    position: relative;
}

.category-connector::before {
    content: '';
    position: absolute;
    left: -8px;
    top: -4px;
    width: 10px;
    height: 10px;
    border: 2px solid #6c757d;
    border-radius: 50%;
    background: white;
}

.category-name {
    font-weight: 600;
    color: #495057;
    font-size: 14px;
}

/* Tools Grid */
.tools-grid {
    padding: 1rem 1.5rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.tool-item {
    background: #6c757d;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.tool-item:hover {
    background: #495057;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

/* Flow Arrows */
.flow-arrow, .flow-arrow-back {
    text-align: center;
    padding: 0.5rem;
    color: white;
    font-size: 20px;
}

.flow-arrow-back {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 0 0 12px 12px;
}

.no-categories {
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    text-align: center;
}

/* Stage-specific colors for tools */
.stage-stack-container:nth-child(odd) .tool-item {
    background: #90C695;
}

.stage-stack-container:nth-child(even) .tool-item {
    background: #7FB3D3;
}

.stage-stack-container:nth-child(odd) .tool-item:hover {
    background: #7BA97D;
}

.stage-stack-container:nth-child(even) .tool-item:hover {
    background: #6BA3C4;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .stacked-lifecycle-container {
        padding: 1rem;
    }
    
    .stage-header {
        padding: 0.75rem 1rem;
    }
    
    .category-header {
        padding: 0.5rem 1rem;
    }
    
    .tools-grid {
        padding: 0.75rem 1rem;
        gap: 0.3rem;
    }
    
    .tool-item {
        font-size: 11px;
        padding: 0.3rem 0.6rem;
    }
    
    .stage-stats {
        display: none;
    }
}

/* Print styles */
@media print {
    .stacked-lifecycle-container {
        background: white !important;
        border: 2px solid #dee2e6;
    }
    
    .stage-header {
        background: #f8f9fa !important;
        color: #333 !important;
    }
    
    .tool-item {
        background: #6c757d !important;
        color: white !important;
    }
}
</style>

{% endblock %}
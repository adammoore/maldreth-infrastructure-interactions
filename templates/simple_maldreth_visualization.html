{% extends "streamlined_base.html" %}

{% block title %}MaLDReTH Official Visualization - PRISM | MaLDReTH II RDA{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-primary mb-3">
                <i class="fas fa-project-diagram me-3"></i>MaLDReTH Research Data Lifecycle
            </h1>
            <p class="lead text-muted">
                Official visualization based on MaLDReTH deliverables showing the 12-stage research data lifecycle with tool mapping
            </p>
            <div class="alert alert-info">
                <small><i class="fas fa-info-circle me-2"></i>
                Based on MaLDReTH Deliverable D2.1 and D3.1 specifications - Circular lifecycle model with interconnected stages
                </small>
            </div>
        </div>
    </div>

    <!-- MaLDReTH Stacked Nested Visualization -->
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="stacked-lifecycle-container">
                <div class="lifecycle-header mb-4">
                    <h3 class="text-center text-white mb-0">MaLDReTH Research Data Lifecycle</h3>
                    <p class="text-center text-light mb-0">Interactive nested visualization showing stages, categories, and tools</p>
                </div>
                
                {% for stage in stages %}
                {% set stage_color = '#90C695' if stage.name in ['CONCEPTUALISE', 'PLAN', 'COLLECT', 'PROCESS', 'ANALYSE', 'STORE'] else '#7FB3D3' %}
                {% set stage_color = '#4A90A4' if stage.name == 'FUND' else stage_color %}
                
                <div class="stage-stack-container mb-3">
                    <!-- Stage Header -->
                    <div class="stage-header" style="background-color: {{ stage_color }};">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="stage-number me-3">{{ stage.position + 1 }}</div>
                                <div>
                                    <h5 class="mb-0 text-white">{{ stage.name.title() }}</h5>
                                    <small class="text-light">{{ stage.description[:50] if stage.description else 'Research data lifecycle stage' }}...</small>
                                </div>
                            </div>
                            <div class="stage-stats text-white">
                                <span class="badge bg-light text-dark me-2">
                                    {% set stage_data = visualization_data.stages | selectattr('id', 'equalto', stage.id) | first %}
                                    {{ stage_data.tool_count if stage_data else 0 }} tools
                                </span>
                                <span class="badge bg-light text-dark">{{ stage.tool_categories.count() }} categories</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Categories and Tools Nested Structure -->
                    {% if stage.tool_categories %}
                    <div class="categories-container">
                        {% for category in stage.tool_categories %}
                        <div class="category-row">
                            <div class="category-header">
                                <div class="category-connector"></div>
                                <div class="category-name">{{ category.name }}</div>
                            </div>
                            <div class="tools-grid">
                                {% for tool in category.tools if tool.is_active %}
                                <div class="tool-item" title="{{ tool.description if tool.description else tool.name }}">
                                    {{ tool.name }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="no-categories">
                        <em class="text-muted">No categories defined for this stage</em>
                    </div>
                    {% endif %}
                    
                    <!-- Flow Arrow to Next Stage -->
                    {% if not loop.last and stage.name != 'TRANSFORM' %}
                    <div class="flow-arrow">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    {% elif stage.name == 'TRANSFORM' %}
                    <div class="flow-arrow-back">
                        <i class="fas fa-arrow-up"></i>
                        <small class="text-muted">Back to Conceptualise</small>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                
            </div>
        </div>
    </div>

    <!-- Stage Details Table -->
    <div class="row mt-4">
        <div class="col-12">
            <h3 class="text-primary mb-3">Research Data Lifecycle Stages</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Stage</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Tools</th>
                            <th>Categories</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set stage_colors = ['#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4'] %}
                        {% for stage in stages %}
                        {% set color = stage_colors[loop.index0 % stage_colors|length] %}
                        <tr style="border-left: 4px solid {{ color }};">
                            <td>
                                <span class="badge rounded-pill" style="background-color: {{ color }};">
                                    {{ stage.position + 1 }}
                                </span>
                            </td>
                            <td><strong>{{ stage.name }}</strong></td>
                            <td>{{ stage.description[:100] if stage.description else "Research data lifecycle stage" }}...</td>
                            <td>
                                {% set stage_data = visualization_data.stages | selectattr('id', 'equalto', stage.id) | first %}
                                <span class="badge bg-primary">{{ stage_data.tool_count if stage_data else 0 }}</span>
                            </td>
                            <td>
                                {% set categories = stage.tool_categories %}
                                <span class="badge bg-secondary">{{ categories.count() if categories else 0 }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tool Categories by Stage -->
    <div class="row mt-4">
        <div class="col-12">
            <h3 class="text-primary mb-3">Tool Categories by Lifecycle Stage</h3>
            <div class="row">
                {% set stage_colors = ['#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4'] %}
                {% for stage in stages %}
                {% if stage.tool_categories %}
                {% set color = stage_colors[loop.index0 % stage_colors|length] %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100" style="border-left: 4px solid {{ color }};">
                        <div class="card-header" style="background-color: {{ color }}20;">
                            <h6 class="mb-0" style="color: {{ color }};">
                                <strong>{{ stage.position + 1 }}. {{ stage.name }}</strong>
                            </h6>
                        </div>
                        <div class="card-body">
                            {% for category in stage.tool_categories %}
                            <div class="mb-2">
                                <small class="fw-bold">{{ category.name }}</small>
                                <br>
                                <small class="text-muted">{{ category.tools.count() }} tools</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced JavaScript for MaLDReTH interactivity
function focusStage(stageName, stageNumber, toolCount) {
    const message = `MaLDReTH Stage ${stageNumber}: ${stageName}\n\nTools Available: ${toolCount}\n\nThis represents the ${stageName.toLowerCase()} phase of the research data lifecycle.\n\nBased on MaLDReTH deliverable specifications for comprehensive tool mapping.`;
    alert(message);
    
    // Highlight connected stages (simplified version of official interconnections)
    highlightStageConnections(stageNumber);
}

function highlightStageConnections(stageNumber) {
    // Remove any existing highlights
    document.querySelectorAll('.stage-highlight').forEach(el => el.classList.remove('stage-highlight'));
    
    // Add highlight class to current stage
    const currentStage = document.querySelector(`[onclick*="focusStage"][onclick*="${stageNumber}"]`);
    if (currentStage) {
        currentStage.classList.add('stage-highlight');
        
        // Remove highlight after 3 seconds
        setTimeout(() => {
            currentStage.classList.remove('stage-highlight');
        }, 3000);
    }
}

// Add CSS filters for mathematical functions (fallback)
if (typeof Math.cos === 'undefined') {
    // Fallback positions if trigonometry isn't available
    console.log('Using fallback positioning');
}
</script>

<!-- Custom CSS for MaLDReTH Stacked Visualization -->
<style>
/* Stacked Lifecycle Container */
.stacked-lifecycle-container {
    background: linear-gradient(135deg, #2C3E50 0%, #3498DB 30%, #9B59B6 70%, #E74C3C 100%);
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.lifecycle-header {
    text-align: center;
    margin-bottom: 2rem;
}

/* Stage Stack Styling */
.stage-stack-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 1rem;
}

.stage-header {
    padding: 1rem 1.5rem;
    border-left: 5px solid rgba(255, 255, 255, 0.3);
}

.stage-number {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
}

/* Categories Container */
.categories-container {
    background: #f8f9fa;
    padding: 0;
}

.category-row {
    border-bottom: 1px solid #e9ecef;
    padding: 0;
}

.category-row:last-child {
    border-bottom: none;
}

.category-header {
    background: #e9ecef;
    padding: 0.75rem 1.5rem;
    display: flex;
    align-items: center;
    border-left: 3px solid #6c757d;
}

.category-connector {
    width: 20px;
    height: 2px;
    background: #6c757d;
    margin-right: 10px;
    position: relative;
}

.category-connector::before {
    content: '';
    position: absolute;
    left: -8px;
    top: -4px;
    width: 10px;
    height: 10px;
    border: 2px solid #6c757d;
    border-radius: 50%;
    background: white;
}

.category-name {
    font-weight: 600;
    color: #495057;
    font-size: 14px;
}

/* Tools Grid */
.tools-grid {
    padding: 1rem 1.5rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.tool-item {
    background: #6c757d;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.tool-item:hover {
    background: #495057;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

/* Flow Arrows */
.flow-arrow, .flow-arrow-back {
    text-align: center;
    padding: 0.5rem;
    color: white;
    font-size: 20px;
}

.flow-arrow-back {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 0 0 12px 12px;
}

.no-categories {
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    text-align: center;
}

/* Stage-specific colors for tools */
.stage-stack-container:nth-child(odd) .tool-item {
    background: #90C695;
}

.stage-stack-container:nth-child(even) .tool-item {
    background: #7FB3D3;
}

.stage-stack-container:nth-child(odd) .tool-item:hover {
    background: #7BA97D;
}

.stage-stack-container:nth-child(even) .tool-item:hover {
    background: #6BA3C4;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .stacked-lifecycle-container {
        padding: 1rem;
    }
    
    .stage-header {
        padding: 0.75rem 1rem;
    }
    
    .category-header {
        padding: 0.5rem 1rem;
    }
    
    .tools-grid {
        padding: 0.75rem 1rem;
        gap: 0.3rem;
    }
    
    .tool-item {
        font-size: 11px;
        padding: 0.3rem 0.6rem;
    }
    
    .stage-stats {
        display: none;
    }
}

/* Print styles */
@media print {
    .stacked-lifecycle-container {
        background: white !important;
        border: 2px solid #dee2e6;
    }
    
    .stage-header {
        background: #f8f9fa !important;
        color: #333 !important;
    }
    
    .tool-item {
        background: #6c757d !important;
        color: white !important;
    }
}
</style>

{% endblock %}
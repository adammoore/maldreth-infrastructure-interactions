{% extends "streamlined_base.html" %}

{% block title %}MaLDReTH Official Visualization - PRISM | MaLDReTH II RDA{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-primary mb-3">
                <i class="fas fa-project-diagram me-3"></i>MaLDReTH Research Data Lifecycle
            </h1>
            <p class="lead text-muted">
                Official visualization based on MaLDReTH deliverables showing the 12-stage research data lifecycle with tool mapping
            </p>
            <div class="alert alert-info">
                <small><i class="fas fa-info-circle me-2"></i>
                Based on MaLDReTH Deliverable D2.1 and D3.1 specifications - Circular lifecycle model with interconnected stages
                </small>
            </div>
        </div>
    </div>

    <!-- MaLDReTH Dual Visualization: Circular + Stacked -->
    <div class="row">
        <!-- Circular Overview -->
        <div class="col-lg-5">
            <div class="circular-overview-container">
                <div class="circular-header mb-3 d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-white mb-0">Official MaLDReTH Flow</h4>
                        <p class="text-light mb-0 small">Based on deliverable diagram</p>
                    </div>
                    <button class="btn btn-outline-light btn-sm" onclick="toggleCircularView()" id="toggle-circular-btn">
                        <i class="fas fa-eye-slash me-1"></i>Hide
                    </button>
                </div>
                
                <!-- Circular SVG Visualization -->
                <div id="circular-viz-container" class="circular-viz-wrapper" style="position: relative; height: 600px;">
                    <svg id="circular-lifecycle" width="100%" height="100%" viewBox="0 0 500 600">
                        <defs>
                            <marker id="arrow-main" markerWidth="10" markerHeight="7" 
                                    refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="rgba(255,255,255,0.9)" />
                            </marker>
                            <marker id="arrow-reverse" markerWidth="10" markerHeight="7" 
                                    refX="9" refY="3.5" orient="auto-start-reverse">
                                <polygon points="0 0, 10 3.5, 0 7" fill="rgba(255,215,0,0.9)" />
                            </marker>
                        </defs>
                        
                        <!-- Title -->
                        <text x="250" y="570" text-anchor="middle" fill="white" font-size="16" font-weight="bold">The MaLDReTH</text>
                        <text x="250" y="590" text-anchor="middle" fill="white" font-size="14">Research Data Lifecycle</text>
                        
                        <!-- Stage nodes and connections will be added by JavaScript -->
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- Stacked Interactive View with Three-Column Layout -->
        <div class="col-lg-7">
            <div class="stacked-lifecycle-container">
                <div class="lifecycle-header mb-4">
                    <h3 class="text-center text-white mb-0">MaLDReTH Research Data Lifecycle</h3>
                    <p class="text-center text-light mb-0">Interactive nested visualization - click stages to expand categories and tools</p>
                    
                    <!-- Interactive Controls -->
                    <div class="text-center mt-3">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-light btn-sm" onclick="resetVisualization()">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="expandAllCategories()">
                                <i class="fas fa-expand-arrows-alt me-1"></i>Show All Categories
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="expandAllTools()">
                                <i class="fas fa-tools me-1"></i>Show All Tools
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Three-Column Layout for Arrows and Content -->
                <div class="three-column-layout">
                    <!-- Left Arrow Strip -->
                    <div class="arrow-strip left-strip">
                        <div class="return-flow-arrow">
                            <div class="return-path"></div>
                            <div class="return-arrow-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="return-label">Return</div>
                        </div>
                    </div>
                    
                    <!-- Central Content Strip -->
                    <div class="content-strip">
                        {% for stage in stages %}
                        {% set stage_color = '#90C695' if stage.name in ['CONCEPTUALISE', 'PLAN', 'COLLECT', 'PROCESS', 'ANALYSE', 'STORE'] else '#7FB3D3' %}
                        {% set stage_color = '#4A90A4' if stage.name == 'FUND' else stage_color %}
                
                        <div class="stage-stack-container mb-2 {{ 'fund-stage' if stage.name == 'FUND' else '' }}" data-stage-id="{{ stage.id }}">
                    
                    <!-- Stage Header - Clickable, Compact -->
                    <div class="stage-header clickable compact" style="background-color: {{ stage_color }};" onclick="toggleStageExpansion({{ stage.id }}); highlightCircularStage({{ stage.id }})">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="stage-number-compact me-2">{{ stage.position + 1 }}</div>
                                <div>
                                    <h6 class="mb-0 text-white stage-title-compact">{{ stage.name.title() }} <i class="fas fa-chevron-down expand-icon ms-1"></i></h6>
                                    <small class="text-light stage-desc-compact">{{ stage.description[:30] if stage.description else 'RDL stage' }}...</small>
                                </div>
                            </div>
                            <div class="stage-stats-compact text-white">
                                <span class="badge bg-light text-dark badge-sm">
                                    {% set stage_data = visualization_data.stages | selectattr('id', 'equalto', stage.id) | first %}
                                    {{ stage_data.tool_count if stage_data else 0 }}
                                </span>
                                <span class="badge bg-light text-dark badge-sm ms-1">{{ stage.tool_categories.count() }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Categories and Tools Nested Structure -->
                    <div class="expandable-content" id="stage-content-{{ stage.id }}" style="display: none;">
                        {% if stage.tool_categories %}
                        <div class="categories-container">
                            {% for category in stage.tool_categories %}
                            <div class="category-row" data-category-id="{{ category.id }}">
                                <div class="category-header clickable" onclick="toggleCategoryExpansion({{ category.id }})">
                                    <div class="category-connector"></div>
                                    <div class="category-name">
                                        {{ category.name }}
                                        <i class="fas fa-chevron-down category-expand-icon ms-2"></i>
                                        <small class="text-muted ms-2">({{ category.tools.count() }} tools)</small>
                                    </div>
                                </div>
                                <div class="tools-grid expandable-tools" id="category-tools-{{ category.id }}" style="display: none;">
                                    {% for tool in category.tools if tool.is_active %}
                                    <a href="{{ url_for('tool_detail', tool_id=tool.id) }}" class="tool-item tool-link" title="{{ tool.description if tool.description else tool.name }}" target="_blank">
                                        {{ tool.name }}
                                        <i class="fas fa-external-link-alt ms-1" style="font-size: 10px; opacity: 0.7;"></i>
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="no-categories">
                            <em class="text-muted">No categories defined for this stage</em>
                        </div>
                        {% endif %}
                    </div>
                </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Right Arrow Strip -->
                    <div class="arrow-strip right-strip">
                        {% for stage in stages %}
                        {% if not loop.first and stage.name != 'FUND' %}
                        <div class="right-flow-arrow" data-stage-index="{{ loop.index0 }}">
                            <div class="brace-lines">
                                <div class="brace-h1"></div>
                                <div class="brace-v"></div>
                                <div class="brace-h2"></div>
                            </div>
                            <div class="flow-arrow-icon">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    </div>

    <!-- Stage Details Table -->
    <div class="row mt-4">
        <div class="col-12">
            <h3 class="text-primary mb-3">Research Data Lifecycle Stages</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Stage</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Tools</th>
                            <th>Categories</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set stage_colors = ['#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4'] %}
                        {% for stage in stages %}
                        {% set color = stage_colors[loop.index0 % stage_colors|length] %}
                        <tr style="border-left: 4px solid {{ color }};">
                            <td>
                                <span class="badge rounded-pill" style="background-color: {{ color }};">
                                    {{ stage.position + 1 }}
                                </span>
                            </td>
                            <td><strong>{{ stage.name }}</strong></td>
                            <td class="expandable-description" onclick="toggleDescription({{ loop.index0 }})">
                                <span class="description-short" id="desc-short-{{ loop.index0 }}">
                                    {{ stage.description[:100] if stage.description else "Research data lifecycle stage" }}...
                                </span>
                                <span class="description-full" id="desc-full-{{ loop.index0 }}" style="display: none;">
                                    {{ stage.description if stage.description else "Research data lifecycle stage" }}
                                </span>
                                <i class="fas fa-chevron-down expand-desc-icon ms-2" id="desc-icon-{{ loop.index0 }}"></i>
                            </td>
                            <td>
                                {% set stage_data = visualization_data.stages | selectattr('id', 'equalto', stage.id) | first %}
                                <span class="badge bg-primary">{{ stage_data.tool_count if stage_data else 0 }}</span>
                            </td>
                            <td>
                                {% set categories = stage.tool_categories %}
                                <span class="badge bg-secondary">{{ categories.count() if categories else 0 }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tool Categories by Stage -->
    <div class="row mt-4">
        <div class="col-12">
            <h3 class="text-primary mb-3">Tool Categories by Lifecycle Stage</h3>
            <div class="row">
                {% set stage_colors = ['#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4', '#90C695', '#7FB3D3', '#4A90A4'] %}
                {% for stage in stages %}
                {% if stage.tool_categories %}
                {% set color = stage_colors[loop.index0 % stage_colors|length] %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100" style="border-left: 4px solid {{ color }};">
                        <div class="card-header" style="background-color: {{ color }}20;">
                            <h6 class="mb-0" style="color: {{ color }};">
                                <strong>{{ stage.position + 1 }}. {{ stage.name }}</strong>
                            </h6>
                        </div>
                        <div class="card-body">
                            {% for category in stage.tool_categories %}
                            <div class="mb-2">
                                <small class="fw-bold">{{ category.name }}</small>
                                <br>
                                <small class="text-muted">{{ category.tools.count() }} tools</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced JavaScript for MaLDReTH interactivity
function focusStage(stageName, stageNumber, toolCount) {
    const message = `MaLDReTH Stage ${stageNumber}: ${stageName}\n\nTools Available: ${toolCount}\n\nThis represents the ${stageName.toLowerCase()} phase of the research data lifecycle.\n\nBased on MaLDReTH deliverable specifications for comprehensive tool mapping.`;
    alert(message);
    
    // Highlight connected stages (simplified version of official interconnections)
    highlightStageConnections(stageNumber);
}

function highlightStageConnections(stageNumber) {
    // Remove any existing highlights
    document.querySelectorAll('.stage-highlight').forEach(el => el.classList.remove('stage-highlight'));
    
    // Add highlight class to current stage
    const currentStage = document.querySelector(`[onclick*="focusStage"][onclick*="${stageNumber}"]`);
    if (currentStage) {
        currentStage.classList.add('stage-highlight');
        
        // Remove highlight after 3 seconds
        setTimeout(() => {
            currentStage.classList.remove('stage-highlight');
        }, 3000);
    }
}

// Interactive Stacked Visualization Functions
function toggleStageExpansion(stageId) {
    const stageContainer = document.querySelector(`[data-stage-id="${stageId}"].stage-stack-container`);
    const contentElement = document.getElementById(`stage-content-${stageId}`);
    
    if (!stageContainer || !contentElement) {
        console.warn(`Stage container or content not found for stage ID: ${stageId}`);
        return;
    }
    
    const expandIcon = stageContainer.querySelector('.expand-icon');
    
    if (contentElement.style.display === 'none' || contentElement.style.display === '') {
        contentElement.style.display = 'block';
        stageContainer.classList.add('expanded');
        if (expandIcon) expandIcon.classList.add('expanded');
    } else {
        contentElement.style.display = 'none';
        stageContainer.classList.remove('expanded');
        if (expandIcon) expandIcon.classList.remove('expanded');
        
        // Also collapse all categories in this stage
        const categories = contentElement.querySelectorAll('.expandable-tools');
        categories.forEach(cat => cat.style.display = 'none');
        const categoryIcons = contentElement.querySelectorAll('.category-expand-icon');
        categoryIcons.forEach(icon => icon.classList.remove('expanded'));
    }
}

function toggleCategoryExpansion(categoryId) {
    const toolsElement = document.getElementById(`category-tools-${categoryId}`);
    const categoryRow = document.querySelector(`[data-category-id="${categoryId}"]`);
    const expandIcon = categoryRow.querySelector('.category-expand-icon');
    
    if (toolsElement.style.display === 'none' || toolsElement.style.display === '') {
        toolsElement.style.display = 'flex';
        expandIcon.classList.add('expanded');
    } else {
        toolsElement.style.display = 'none';
        expandIcon.classList.remove('expanded');
    }
}

function resetVisualization() {
    // Collapse all stages
    document.querySelectorAll('.expandable-content').forEach(content => {
        content.style.display = 'none';
    });
    
    // Collapse all categories
    document.querySelectorAll('.expandable-tools').forEach(tools => {
        tools.style.display = 'none';
    });
    
    // Reset all expand icons
    document.querySelectorAll('.expand-icon, .category-expand-icon').forEach(icon => {
        icon.classList.remove('expanded');
    });
    
    // Reset stage containers
    document.querySelectorAll('.stage-stack-container').forEach(container => {
        container.classList.remove('expanded');
    });
}

function expandAllCategories() {
    // Show all stage content
    document.querySelectorAll('.expandable-content').forEach(content => {
        content.style.display = 'block';
    });
    
    // Mark all stages as expanded
    document.querySelectorAll('.stage-stack-container').forEach(container => {
        container.classList.add('expanded');
    });
    
    // Show all stage expand icons as expanded
    document.querySelectorAll('.expand-icon').forEach(icon => {
        icon.classList.add('expanded');
    });
    
    // Keep tools collapsed
    document.querySelectorAll('.expandable-tools').forEach(tools => {
        tools.style.display = 'none';
    });
    
    document.querySelectorAll('.category-expand-icon').forEach(icon => {
        icon.classList.remove('expanded');
    });
}

function expandAllTools() {
    // Show all stage content and categories
    expandAllCategories();
    
    // Show all tools
    document.querySelectorAll('.expandable-tools').forEach(tools => {
        tools.style.display = 'flex';
    });
    
    // Show all category expand icons as expanded
    document.querySelectorAll('.category-expand-icon').forEach(icon => {
        icon.classList.add('expanded');
    });
}

// Initialize circular visualization based on official MaLDReTH diagram
function initializeCircularVisualization() {
    const stages = {{ stages_json | tojson | safe }};
    const svg = document.getElementById('circular-lifecycle');
    
    if (!svg) {
        console.error('SVG element not found');
        return;
    }
    
    // Official MaLDReTH stage positions with improved spacing for better legibility
    const stagePositions = {
        'CONCEPTUALISE': { x: 60, y: 200, width: 120, height: 50 },
        'FUND': { x: 180, y: 140, width: 90, height: 50 },
        'PLAN': { x: 300, y: 180, width: 90, height: 50 },
        'COLLECT': { x: 420, y: 200, width: 90, height: 50 },
        'PROCESS': { x: 450, y: 290, width: 90, height: 50 },
        'ANALYSE': { x: 450, y: 380, width: 90, height: 50 },
        'STORE': { x: 420, y: 470, width: 90, height: 50 },
        'PUBLISH': { x: 300, y: 500, width: 90, height: 50 },
        'PRESERVE': { x: 180, y: 470, width: 90, height: 50 },
        'SHARE': { x: 60, y: 440, width: 90, height: 50 },
        'ACCESS': { x: 60, y: 360, width: 90, height: 50 },
        'TRANSFORM': { x: 60, y: 280, width: 90, height: 50 }
    };
    
    // Create stage rectangles with names
    stages.forEach((stage, index) => {
        const pos = stagePositions[stage.name];
        if (!pos) return;
        
        const stageColor = stage.name === 'FUND' ? '#4A90A4' : 
                          ['CONCEPTUALISE', 'PLAN', 'COLLECT', 'PROCESS', 'ANALYSE', 'STORE'].includes(stage.name) ? '#90C695' : '#7FB3D3';
        
        // Stage rectangle
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', pos.x - pos.width/2);
        rect.setAttribute('y', pos.y - pos.height/2);
        rect.setAttribute('width', pos.width);
        rect.setAttribute('height', pos.height);
        rect.setAttribute('fill', stageColor);
        rect.setAttribute('stroke', 'rgba(255,255,255,0.8)');
        rect.setAttribute('stroke-width', '2');
        rect.setAttribute('rx', '8');
        rect.setAttribute('class', 'circular-stage-node');
        rect.setAttribute('data-stage-id', stage.id);
        rect.setAttribute('data-stage-name', stage.name);
        rect.style.cursor = 'pointer';
        rect.onclick = () => {
            highlightCircularStage(stage.id);
            const stageElement = document.querySelector(`[data-stage-id="${stage.id}"].stage-stack-container`);
            if (stageElement) {
                toggleStageExpansion(stage.id);
                stageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };
        svg.appendChild(rect);
        
        // Stage name text
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', pos.x);
        text.setAttribute('y', pos.y + 5);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', 'white');
        text.setAttribute('font-size', '12');
        text.setAttribute('font-weight', 'bold');
        text.textContent = stage.name.charAt(0).toUpperCase() + stage.name.slice(1).toLowerCase();
        text.style.pointerEvents = 'none';
        svg.appendChild(text);
    });
    
    // Add official flow connections
    const connections = [
        // Main flow (solid arrows)
        { from: 'FUND', to: 'PLAN', type: 'main' },
        { from: 'CONCEPTUALISE', to: 'FUND', type: 'main' },
        { from: 'CONCEPTUALISE', to: 'PLAN', type: 'main' },
        { from: 'PLAN', to: 'COLLECT', type: 'main' },
        { from: 'COLLECT', to: 'PROCESS', type: 'main' },
        { from: 'PROCESS', to: 'ANALYSE', type: 'main' },
        { from: 'ANALYSE', to: 'STORE', type: 'main' },
        { from: 'STORE', to: 'PUBLISH', type: 'main' },
        { from: 'PUBLISH', to: 'PRESERVE', type: 'main' },
        { from: 'PRESERVE', to: 'SHARE', type: 'main' },
        { from: 'SHARE', to: 'ACCESS', type: 'main' },
        { from: 'ACCESS', to: 'TRANSFORM', type: 'main' },
        { from: 'TRANSFORM', to: 'CONCEPTUALISE', type: 'main' },
        
        // Bidirectional connections (dashed arrows) - reverse direction
        { from: 'PROCESS', to: 'COLLECT', type: 'bidirectional' },
        { from: 'ANALYSE', to: 'PROCESS', type: 'bidirectional' },
        { from: 'STORE', to: 'ANALYSE', type: 'bidirectional' }
    ];
    
    connections.forEach(conn => {
        const fromPos = stagePositions[conn.from];
        const toPos = stagePositions[conn.to];
        
        if (fromPos && toPos) {
            // Calculate edge-to-edge connection points with proper spacing
            const deltaX = toPos.x - fromPos.x;
            const deltaY = toPos.y - fromPos.y;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            
            if (distance === 0) return; // Skip if same position
            
            // Normalize direction vector
            const dirX = deltaX / distance;
            const dirY = deltaY / distance;
            
            // Calculate exact edge points with better edge detection
            // Account for rectangle bounds properly
            let fromEdgeX, fromEdgeY, toEdgeX, toEdgeY;
            
            // From node edge calculation
            if (Math.abs(dirX) > Math.abs(dirY)) {
                // Horizontal-dominant direction - use left/right edges
                fromEdgeX = fromPos.x + Math.sign(dirX) * (fromPos.width / 2);
                fromEdgeY = fromPos.y + dirY * (fromPos.height / 2) * Math.abs(dirX);
            } else {
                // Vertical-dominant direction - use top/bottom edges
                fromEdgeX = fromPos.x + dirX * (fromPos.width / 2) * Math.abs(dirY);
                fromEdgeY = fromPos.y + Math.sign(dirY) * (fromPos.height / 2);
            }
            
            // To node edge calculation
            if (Math.abs(dirX) > Math.abs(dirY)) {
                // Horizontal-dominant direction - use left/right edges
                toEdgeX = toPos.x - Math.sign(dirX) * (toPos.width / 2);
                toEdgeY = toPos.y - dirY * (toPos.height / 2) * Math.abs(dirX);
            } else {
                // Vertical-dominant direction - use top/bottom edges
                toEdgeX = toPos.x - dirX * (toPos.width / 2) * Math.abs(dirY);
                toEdgeY = toPos.y - Math.sign(dirY) * (toPos.height / 2);
            }
            
            // Enhanced offset for bidirectional arrows to prevent overlap
            let offsetX = 0, offsetY = 0;
            if (conn.type === 'bidirectional') {
                // Larger perpendicular offset (rotate direction 90 degrees)
                offsetX = -dirY * 12; // Increased offset for better visibility
                offsetY = dirX * 12;
            }
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', fromEdgeX + offsetX);
            line.setAttribute('y1', fromEdgeY + offsetY);
            line.setAttribute('x2', toEdgeX + offsetX);
            line.setAttribute('y2', toEdgeY + offsetY);
            
            if (conn.type === 'bidirectional') {
                line.setAttribute('stroke', 'rgba(255,215,0,0.95)');
                line.setAttribute('stroke-dasharray', '5,3');
                line.setAttribute('marker-end', 'url(#arrow-reverse)');
                line.setAttribute('stroke-width', '3');
                line.setAttribute('opacity', '0.9');
            } else {
                line.setAttribute('stroke', 'rgba(255,255,255,0.85)');
                line.setAttribute('marker-end', 'url(#arrow-main)');
                line.setAttribute('stroke-width', '2.5');
                line.setAttribute('opacity', '0.95');
            }
            
            svg.appendChild(line);
        }
    });
}

function highlightCircularStage(stageId) {
    // Remove existing highlights
    document.querySelectorAll('.circular-stage-node').forEach(node => {
        node.setAttribute('stroke-width', '2');
        node.setAttribute('stroke', 'rgba(255,255,255,0.8)');
    });
    
    // Highlight current stage
    const currentNode = document.querySelector(`[data-stage-id="${stageId}"].circular-stage-node`);
    if (currentNode) {
        currentNode.setAttribute('stroke-width', '4');
        currentNode.setAttribute('stroke', '#FFD700');
    }
}

function toggleCircularView() {
    const circularCol = document.querySelector('.col-lg-5');
    const stackedCol = document.querySelector('.col-lg-7');
    const overviewContainer = document.querySelector('.circular-overview-container');
    const container = document.getElementById('circular-viz-container');
    const button = document.getElementById('toggle-circular-btn');
    const headerDiv = button.closest('.circular-header').querySelector('div:first-child');
    
    if (!container || !button || !circularCol || !stackedCol || !overviewContainer) return;
    
    if (container.style.display === 'none') {
        // Show circular view - restore full dimensions
        container.style.display = 'block';
        circularCol.className = 'col-lg-5';
        stackedCol.className = 'col-lg-7';
        overviewContainer.classList.remove('collapsed');
        overviewContainer.style.height = 'fit-content';
        overviewContainer.style.width = 'auto';
        if (headerDiv) headerDiv.style.display = 'block';
        button.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide';
        // Clear and reinitialize the circular visualization to ensure it renders properly
        setTimeout(() => {
            const svg = document.getElementById('circular-lifecycle');
            if (svg) {
                // Clear all existing elements except defs and title
                const elementsToKeep = svg.querySelectorAll('defs, text');
                svg.innerHTML = '';
                elementsToKeep.forEach(el => svg.appendChild(el.cloneNode(true)));
            }
            initializeCircularVisualization();
        }, 150);
    } else {
        // Hide circular view and minimize container dimensions
        container.style.display = 'none';
        circularCol.className = 'col-lg-1'; // Minimize column width
        stackedCol.className = 'col-lg-11'; // Expand stacked view
        overviewContainer.classList.add('collapsed');
        overviewContainer.style.height = '80px'; // Reduce height significantly
        overviewContainer.style.width = '100px'; // Reduce width as well
        if (headerDiv) headerDiv.style.display = 'none'; // Hide title when collapsed
        button.innerHTML = '<i class="fas fa-eye me-1"></i>Show';
    }
}

// Toggle description in table
function toggleDescription(index) {
    const shortDesc = document.getElementById(`desc-short-${index}`);
    const fullDesc = document.getElementById(`desc-full-${index}`);
    const icon = document.getElementById(`desc-icon-${index}`);
    
    if (fullDesc.style.display === 'none') {
        shortDesc.style.display = 'none';
        fullDesc.style.display = 'inline';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    } else {
        shortDesc.style.display = 'inline';
        fullDesc.style.display = 'none';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeCircularVisualization();
});

// Add CSS filters for mathematical functions (fallback)
if (typeof Math.cos === 'undefined') {
    // Fallback positions if trigonometry isn't available
    console.log('Using fallback positioning');
}
</script>

<!-- Custom CSS for MaLDReTH Stacked Visualization -->
<style>
/* Circular Overview Container */
.circular-overview-container {
    background: linear-gradient(135deg, #2C3E50 0%, #3498DB 50%, #9B59B6 100%);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    height: fit-content;
    transition: all 0.3s ease;
}

.circular-overview-container.collapsed {
    padding: 0.5rem;
    text-align: center;
}

.circular-header {
    text-align: center;
}

.circular-viz-wrapper {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 1rem;
}

/* Stacked Lifecycle Container */
.stacked-lifecycle-container {
    background: linear-gradient(135deg, #2C3E50 0%, #3498DB 30%, #9B59B6 70%, #E74C3C 100%);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

/* Three-Column Layout for Arrows and Content */
.three-column-layout {
    display: grid;
    grid-template-columns: 80px 1fr 80px;
    gap: 0;
    position: relative;
    min-height: 600px;
}

/* Arrow Strips */
.arrow-strip {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
}

.left-strip {
    background: rgba(231, 76, 60, 0.1);
    border-radius: 8px 0 0 8px;
    padding: 20px 0;
}

.right-strip {
    background: rgba(52, 152, 219, 0.1);
    border-radius: 0 8px 8px 0;
    padding: 20px 0;
}

/* Content Strip */
.content-strip {
    padding: 0 10px;
    position: relative;
}

.lifecycle-header {
    text-align: center;
    margin-bottom: 2rem;
}

/* Stage Stack Styling */
.stage-stack-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 2.5rem;
    transition: all 0.3s ease;
    position: relative;
}

.stage-stack-container.expanded {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
}

/* Fund stage positioned out of line */
.stage-stack-container.fund-stage {
    margin-left: 2rem;
    margin-right: 2rem;
    position: relative;
    border: 2px solid rgba(74, 144, 164, 0.3);
    transform: translateX(-1rem);
}

.stage-stack-container.fund-stage::before {
    content: '';
    position: absolute;
    left: -15px;
    top: 50%;
    width: 15px;
    height: 2px;
    background: rgba(74, 144, 164, 0.6);
    transform: translateY(-50%);
    border-radius: 1px;
}

.stage-stack-container.fund-stage::after {
    content: 'External Funding';
    position: absolute;
    right: -120px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    color: rgba(255, 255, 255, 0.7);
    background: rgba(74, 144, 164, 0.8);
    padding: 2px 6px;
    border-radius: 8px;
    white-space: nowrap;
}

/* Right Strip Flow Arrows */
.right-flow-arrow {
    position: relative;
    margin: 60px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.brace-lines {
    position: relative;
    width: 60px;
    height: 40px;
}

.brace-h1 {
    position: absolute;
    top: 0;
    left: 0;
    width: 40px;
    height: 4px;
    background: linear-gradient(to right, #3498db, #2980b9);
    border-radius: 2px;
}

.brace-v {
    position: absolute;
    top: 0;
    left: 36px;
    width: 4px;
    height: 20px;
    background: linear-gradient(to bottom, #2980b9, #3498db);
    border-radius: 2px;
}

.brace-h2 {
    position: absolute;
    top: 16px;
    left: 40px;
    width: 20px;
    height: 4px;
    background: linear-gradient(to right, #3498db, #2980b9);
    border-radius: 2px;
}

.flow-arrow-icon {
    background: linear-gradient(135deg, #2980b9, #3498db);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border: 3px solid rgba(255, 255, 255, 0.9);
    animation: right-flow-pulse 3s infinite;
    margin-top: 10px;
}

@keyframes right-flow-pulse {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    50% { 
        transform: scale(1.15);
        box-shadow: 0 6px 18px rgba(52, 152, 219, 0.5);
    }
}

/* Left Strip Return Arrow */
.return-flow-arrow {
    position: absolute;
    bottom: 50px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
}

.return-path {
    width: 4px;
    height: 300px;
    background: linear-gradient(to top, #e74c3c, #c0392b);
    border-radius: 2px;
    position: relative;
}

.return-path::before {
    content: '';
    position: absolute;
    top: -10px;
    left: -8px;
    width: 20px;
    height: 4px;
    background: linear-gradient(to right, #e74c3c, #c0392b);
    border-radius: 2px;
}

.return-arrow-icon {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border: 3px solid rgba(255, 255, 255, 0.9);
    animation: return-flow-pulse 4s infinite;
    margin-top: -320px;
}

.return-label {
    color: white;
    font-size: 12px;
    font-weight: bold;
    margin-top: 8px;
    background: rgba(231, 76, 60, 0.8);
    padding: 4px 8px;
    border-radius: 6px;
}

@keyframes return-flow-pulse {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    50% { 
        transform: scale(1.2);
        box-shadow: 0 6px 18px rgba(231, 76, 60, 0.5);
    }
}

/* Fund special connectors */
.fund-connectors {
    position: absolute;
    top: 50%;
    left: 100%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 25;
}

.fund-arrow {
    display: flex;
    align-items: center;
    gap: 5px;
    background: rgba(74, 144, 164, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 15px;
    font-size: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    white-space: nowrap;
}

.fund-arrow-right {
    margin-left: 10px;
}

.fund-arrow-left {
    margin-left: 10px;
    flex-direction: row-reverse;
}

.fund-target {
    font-size: 10px;
    font-weight: 600;
}

.stage-header {
    padding: 1rem 1.5rem;
    border-left: 5px solid rgba(255, 255, 255, 0.3);
    transition: all 0.3s ease;
}

.stage-header.compact {
    padding: 0.75rem 1rem;
}

/* Compact Stage Elements */
.stage-title-compact {
    font-size: 14px;
    font-weight: 600;
}

.stage-desc-compact {
    font-size: 11px;
    opacity: 0.9;
}

.stage-number-compact {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
}

.stage-stats-compact .badge-sm {
    font-size: 10px;
    padding: 0.2rem 0.4rem;
}

/* Brace-style Arrow Connectors on Right Side */
.brace-arrow-connector {
    position: absolute;
    top: -25px;
    right: -30px;
    width: 60px;
    height: 50px;
    z-index: 25;
}

.brace-line-horizontal {
    position: absolute;
    top: 0;
    left: 0;
    width: 30px;
    height: 3px;
    background: linear-gradient(to right, #3498db, #2980b9);
    border-radius: 2px;
}

.brace-line-vertical {
    position: absolute;
    top: 0;
    left: 27px;
    width: 3px;
    height: 25px;
    background: linear-gradient(to bottom, #2980b9, #3498db);
    border-radius: 2px;
}

.brace-line-horizontal-down {
    position: absolute;
    top: 22px;
    left: 30px;
    width: 30px;
    height: 3px;
    background: linear-gradient(to right, #3498db, #2980b9);
    border-radius: 2px;
}

.brace-arrow {
    position: absolute;
    top: 15px;
    right: -10px;
    background: linear-gradient(135deg, #2980b9, #3498db);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.9);
    animation: flow-pulse 3s infinite;
}

@keyframes flow-pulse {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    }
    50% { 
        transform: scale(1.1);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
    }
}

/* Left Return Connector - Cycle back to top */
.left-return-connector {
    position: absolute;
    bottom: -30px;
    left: -40px;
    width: 80px;
    height: 200px;
    z-index: 30;
}

.return-line-horizontal {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 40px;
    height: 3px;
    background: linear-gradient(to left, #e74c3c, #c0392b);
    border-radius: 2px;
}

.return-line-vertical-long {
    position: absolute;
    bottom: 0;
    left: -3px;
    width: 3px;
    height: 180px;
    background: linear-gradient(to top, #c0392b, #e74c3c);
    border-radius: 2px;
}

.return-line-horizontal-top {
    position: absolute;
    top: 0;
    left: -3px;
    width: 50px;
    height: 3px;
    background: linear-gradient(to right, #e74c3c, #c0392b);
    border-radius: 2px;
}

.return-arrow {
    position: absolute;
    top: -8px;
    right: -10px;
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.9);
    animation: return-pulse 4s infinite;
}

.return-text {
    position: absolute;
    top: -35px;
    left: -20px;
    font-size: 10px;
    color: rgba(255, 255, 255, 0.9);
    background: rgba(231, 76, 60, 0.8);
    padding: 2px 6px;
    border-radius: 8px;
    white-space: nowrap;
}

@keyframes return-pulse {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    }
    50% { 
        transform: scale(1.15);
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
    }
}

.circular-connector {
    position: absolute;
    bottom: -40px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 30;
    background: transparent;
    padding: 10px;
    width: 120px;
    height: 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.circular-line {
    width: 60px;
    height: 4px;
    background: linear-gradient(to right, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.9) 20%, rgba(255, 255, 255, 0.9) 80%, rgba(255, 255, 255, 0.2) 100%);
    margin: 0 auto 8px;
    border-radius: 3px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    position: relative;
}

.circular-line::after {
    content: '↺';
    position: absolute;
    right: -15px;
    top: -8px;
    font-size: 20px;
    color: rgba(255, 255, 255, 0.9);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}

.circular-arrow {
    color: rgba(255, 255, 255, 0.95);
    font-size: 18px;
    text-align: center;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.8));
    border: 3px solid rgba(255, 255, 255, 0.4);
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4);
    margin: 0 auto 8px;
}

.circular-text {
    text-align: center;
    font-size: 11px;
    color: rgba(255, 255, 255, 0.9);
    background: rgba(0, 0, 0, 0.3);
    padding: 3px 8px;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.clickable {
    cursor: pointer;
    transition: all 0.3s ease;
}

.clickable:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.expand-icon, .category-expand-icon {
    transition: transform 0.3s ease;
    font-size: 12px;
}

.expand-icon.expanded, .category-expand-icon.expanded {
    transform: rotate(180deg);
}

.stage-number {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
}

/* Categories Container */
.categories-container {
    background: #f8f9fa;
    padding: 0;
}

.category-row {
    border-bottom: 1px solid #e9ecef;
    padding: 0;
}

.category-row:last-child {
    border-bottom: none;
}

.category-header {
    background: #e9ecef;
    padding: 0.75rem 1.5rem;
    display: flex;
    align-items: center;
    border-left: 3px solid #6c757d;
    transition: background-color 0.3s ease;
}

.category-header:hover {
    background: #dee2e6;
}

.expandable-content {
    animation: slideDown 0.3s ease-out;
}

.expandable-tools {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}

.category-connector {
    width: 20px;
    height: 2px;
    background: #6c757d;
    margin-right: 10px;
    position: relative;
}

.category-connector::before {
    content: '';
    position: absolute;
    left: -8px;
    top: -4px;
    width: 10px;
    height: 10px;
    border: 2px solid #6c757d;
    border-radius: 50%;
    background: white;
}

.category-name {
    font-weight: 600;
    color: #495057;
    font-size: 14px;
}

/* Tools Grid */
.tools-grid {
    padding: 1rem 1.5rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.tool-item {
    background: #6c757d;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.tool-item:hover {
    background: #495057;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

/* Tool links styling */
.tool-item.tool-link {
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    position: relative;
}

.tool-item.tool-link:hover {
    text-decoration: none;
    color: white;
    background: #343a40;
}

.tool-item.tool-link:focus {
    outline: 2px solid rgba(255, 255, 255, 0.5);
    outline-offset: 2px;
}

.tool-item.tool-link .fas.fa-external-link-alt {
    opacity: 0;
    transition: opacity 0.2s ease;
}

.tool-item.tool-link:hover .fas.fa-external-link-alt {
    opacity: 0.8;
}

/* Flow Arrows */
.flow-arrow, .flow-arrow-back {
    text-align: center;
    padding: 0.5rem;
    color: white;
    font-size: 20px;
}

.flow-arrow-back {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 0 0 12px 12px;
}

.no-categories {
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    text-align: center;
}

/* Stage-specific colors for tools */
.stage-stack-container:nth-child(odd) .tool-item {
    background: #90C695;
}

.stage-stack-container:nth-child(even) .tool-item {
    background: #7FB3D3;
}

.stage-stack-container:nth-child(odd) .tool-item:hover {
    background: #7BA97D;
}

.stage-stack-container:nth-child(even) .tool-item:hover {
    background: #6BA3C4;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .stacked-lifecycle-container {
        padding: 1rem;
    }
    
    .stage-header {
        padding: 0.75rem 1rem;
    }
    
    .category-header {
        padding: 0.5rem 1rem;
    }
    
    .tools-grid {
        padding: 0.75rem 1rem;
        gap: 0.3rem;
    }
    
    .tool-item {
        font-size: 11px;
        padding: 0.3rem 0.6rem;
    }
    
    .stage-stats {
        display: none;
    }
}

/* Expandable descriptions in table */
.expandable-description {
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.expandable-description:hover {
    background: rgba(0, 123, 255, 0.1);
    border-radius: 4px;
}

.expand-desc-icon {
    font-size: 12px;
    color: #6c757d;
    transition: transform 0.3s ease;
}

.expand-desc-icon.fa-chevron-up {
    transform: rotate(180deg);
}

.description-full {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Print styles */
@media print {
    .stacked-lifecycle-container {
        background: white !important;
        border: 2px solid #dee2e6;
    }
    
    .stage-header {
        background: #f8f9fa !important;
        color: #333 !important;
    }
    
    .tool-item {
        background: #6c757d !important;
        color: white !important;
    }
    
    .description-full {
        display: inline !important;
    }
    
    .description-short {
        display: none !important;
    }
    
    .expand-desc-icon {
        display: none !important;
    }
}

/* Build Information Footer */
.build-info-footer {
    position: fixed;
    bottom: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.8);
    color: rgba(255, 255, 255, 0.8);
    padding: 8px 12px;
    font-size: 11px;
    font-family: 'Courier New', monospace;
    border-radius: 8px 0 0 0;
    z-index: 1000;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-right: none;
    border-bottom: none;
}

.build-info-footer:hover {
    background: rgba(0, 0, 0, 0.9);
    color: rgba(255, 255, 255, 1);
}
</style>

<!-- Build Information Footer -->
<div class="build-info-footer">
    <div>Build: <span id="build-number">{{ build_number if build_number else '2024.003' }}</span></div>
    <div>Date: <span id="build-date"></span></div>
    <div>Time: <span id="build-time"></span></div>
</div>

<script>
// Add build timestamp information
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const buildDate = now.toISOString().split('T')[0];
    const buildTime = now.toTimeString().split(' ')[0];
    
    document.getElementById('build-date').textContent = buildDate;
    document.getElementById('build-time').textContent = buildTime;
});
</script>

{% endblock %}
{% extends "streamlined_base.html" %}

{% block title %}MaLDReTH Official Visualization - PRISM | MaLDReTH II RDA{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-primary mb-3">
                <i class="fas fa-project-diagram me-3"></i>MaLDReTH Research Data Lifecycle
            </h1>
            <p class="lead text-muted">
                Official visualization based on MaLDReTH deliverables showing the 12-stage research data lifecycle with tool mapping
            </p>
            <div class="alert alert-info">
                <small><i class="fas fa-info-circle me-2"></i>
                Based on MaLDReTH Deliverable D2.1 and D3.1 specifications - Circular lifecycle model with interconnected stages
                </small>
            </div>
        </div>
    </div>

    <!-- Simple Circular Visualization -->
    <div class="row justify-content-center">
        <div class="col-12">
            <div style="background: linear-gradient(135deg, #2C3E50 0%, #3498DB 30%, #9B59B6 70%, #E74C3C 100%); 
                        border-radius: 15px; padding: 2rem; min-height: 600px; position: relative;">
                
                <!-- Title Area (replacing central circle) -->
                <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
                           text-align: center; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                    <h4 style="margin: 0; font-size: 24px; font-weight: bold;">The MaLDReTH</h4>
                    <h5 style="margin: 5px 0 0 0; font-size: 20px; font-weight: normal;">Research Data Lifecycle</h5>
                </div>

                <!-- Official MaLDReTH Flow Arrows -->
                <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="rgba(255,255,255,0.7)" />
                        </marker>
                        <marker id="arrowhead-dashed" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="rgba(255,255,255,0.5)" />
                        </marker>
                    </defs>
                    
                    <!-- Main flow arrows following official MaLDReTH pattern -->
                    <!-- Fund to Plan -->
                    <line x1="42%" y1="14%" x2="42%" y2="21%" stroke="rgba(255,255,255,0.8)" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Plan to Collect -->
                    <line x1="50%" y1="25%" x2="62%" y2="30%" stroke="rgba(255,255,255,0.8)" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Collect to Process -->
                    <line x1="75%" y1="35%" x2="82%" y2="45%" stroke="rgba(255,255,255,0.8)" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Process to Analyse -->
                    <line x1="85%" y1="55%" x2="85%" y2="65%" stroke="rgba(255,255,255,0.8)" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Analyse to Store -->
                    <line x1="80%" y1="75%" x2="75%" y2="82%" stroke="rgba(255,255,255,0.8)" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Store to Publish -->
                    <line x1="65%" y1="87%" x2="50%" y2="88%" stroke="rgba(255,255,255,0.8)" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Publish to Preserve -->
                    <line x1="38%" y1="90%" x2="30%" y2="87%" stroke="rgba(255,255,255,0.8)" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Preserve to Share -->
                    <line x1="22%" y1="82%" x2="17%" y2="75%" stroke="rgba(255,255,255,0.8)" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Share to Access -->
                    <line x1="15%" y1="65%" x2="15%" y2="55%" stroke="rgba(255,255,255,0.8)" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Access to Transform -->
                    <line x1="15%" y1="45%" x2="15%" y2="35%" stroke="rgba(255,255,255,0.8)" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Transform to Conceptualise -->
                    <line x1="15%" y1="32%" x2="15%" y2="37%" stroke="rgba(255,255,255,0.8)" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Conceptualise to Plan -->
                    <line x1="23%" y1="35%" x2="35%" y2="27%" stroke="rgba(255,255,255,0.8)" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Bidirectional arrows (official MaLDReTH pattern) -->
                    <defs>
                        <marker id="arrowhead-bi" markerWidth="8" markerHeight="6" 
                                refX="4" refY="3" orient="auto">
                            <polygon points="0 1.5, 8 3, 0 4.5" fill="rgba(255,215,0,0.9)" />
                        </marker>
                    </defs>
                    
                    <!-- Fund bidirectional connection to Conceptualise -->
                    <line x1="35%" y1="12%" x2="20%" y2="30%" stroke="rgba(255,215,0,0.7)" stroke-width="2" stroke-dasharray="3,3" marker-start="url(#arrowhead-bi)" marker-end="url(#arrowhead-bi)"/>
                    
                    <!-- Store to Access bidirectional -->
                    <line x1="62%" y1="82%" x2="22%" y2="55%" stroke="rgba(255,215,0,0.7)" stroke-width="2" stroke-dasharray="3,3" marker-start="url(#arrowhead-bi)" marker-end="url(#arrowhead-bi)"/>
                    
                    <!-- Process to Share bidirectional -->
                    <line x1="78%" y1="45%" x2="22%" y2="65%" stroke="rgba(255,215,0,0.7)" stroke-width="2" stroke-dasharray="3,3" marker-start="url(#arrowhead-bi)" marker-end="url(#arrowhead-bi)"/>
                    
                    <!-- Analyse to Transform bidirectional -->
                    <line x1="78%" y1="65%" x2="22%" y2="35%" stroke="rgba(255,215,0,0.7)" stroke-width="2" stroke-dasharray="3,3" marker-start="url(#arrowhead-bi)" marker-end="url(#arrowhead-bi)"/>
                </svg>

                <!-- Stage Boxes - Official MaLDReTH Layout -->
                {% set stage_positions = {
                    'FUND': {'x': 42, 'y': 10, 'color': '#4A90A4', 'text_color': '#FFFFFF'},
                    'CONCEPTUALISE': {'x': 15, 'y': 35, 'color': '#7FB3D3', 'text_color': '#2C3E50'}, 
                    'PLAN': {'x': 42, 'y': 25, 'color': '#90C695', 'text_color': '#2C3E50'},
                    'COLLECT': {'x': 70, 'y': 30, 'color': '#90C695', 'text_color': '#2C3E50'},
                    'PROCESS': {'x': 85, 'y': 50, 'color': '#90C695', 'text_color': '#2C3E50'},
                    'ANALYSE': {'x': 85, 'y': 70, 'color': '#90C695', 'text_color': '#2C3E50'},
                    'STORE': {'x': 70, 'y': 85, 'color': '#90C695', 'text_color': '#2C3E50'},
                    'PUBLISH': {'x': 42, 'y': 90, 'color': '#7FB3D3', 'text_color': '#2C3E50'},
                    'PRESERVE': {'x': 25, 'y': 85, 'color': '#7FB3D3', 'text_color': '#2C3E50'},
                    'SHARE': {'x': 15, 'y': 70, 'color': '#7FB3D3', 'text_color': '#2C3E50'},
                    'ACCESS': {'x': 15, 'y': 50, 'color': '#7FB3D3', 'text_color': '#2C3E50'},
                    'TRANSFORM': {'x': 15, 'y': 30, 'color': '#7FB3D3', 'text_color': '#2C3E50'}
                } %}
                
                {% for stage in stages %}
                {% set pos = stage_positions.get(stage.name, {'x': 50, 'y': 50, 'color': '#90C695'}) %}
                {% set stage_data = visualization_data.stages | selectattr('id', 'equalto', stage.id) | first %}
                {% set tool_count = stage_data.tool_count if stage_data else 0 %}
                
                <!-- Stage Box - Official MaLDReTH Style -->
                <div style="position: absolute; 
                           left: {{ pos.x }}%; top: {{ pos.y }}%; 
                           transform: translate(-50%, -50%);
                           width: 100px; 
                           height: 60px; 
                           background: {{ pos.color }}; 
                           border: 2px solid #2C3E50; 
                           border-radius: 8px; 
                           display: flex; align-items: center; justify-content: center;
                           cursor: pointer;
                           transition: all 0.3s ease;
                           box-shadow: 0 4px 12px rgba(0,0,0,0.2);"
                     onmouseover="this.style.transform='translate(-50%, -50%) scale(1.05)'; this.style.boxShadow='0 6px 18px rgba(0,0,0,0.3)'"
                     onmouseout="this.style.transform='translate(-50%, -50%) scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'"
                     onclick="focusStage('{{ stage.name }}', {{ loop.index }}, {{ tool_count }})"
                     title="Stage {{ loop.index }}: {{ stage.name }} ({{ tool_count }} tools)">
                    
                    <div style="color: {{ pos.text_color if pos.text_color else '#2C3E50' }}; font-weight: bold; text-align: center; font-size: 14px;">
                        {{ stage.name.title() if stage.name != 'FUND' else stage.name }}
                        {% if tool_count > 0 %}
                        <div style="font-size: 10px; opacity: 0.8;">({{ tool_count }})</div>
                        {% endif %}
                    </div>
                </div>

                {% endfor %}

            </div>
        </div>
    </div>

    <!-- Stage Details Table -->
    <div class="row mt-4">
        <div class="col-12">
            <h3 class="text-primary mb-3">Research Data Lifecycle Stages</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Stage</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Tools</th>
                            <th>Categories</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stage in stages %}
                        {% set color = stage_colors[loop.index0 % stage_colors|length] %}
                        <tr style="border-left: 4px solid {{ color }};">
                            <td>
                                <span class="badge rounded-pill" style="background-color: {{ color }};">
                                    {{ stage.position + 1 }}
                                </span>
                            </td>
                            <td><strong>{{ stage.name }}</strong></td>
                            <td>{{ stage.description[:100] if stage.description else "Research data lifecycle stage" }}...</td>
                            <td>
                                {% set stage_data = visualization_data.stages | selectattr('id', 'equalto', stage.id) | first %}
                                <span class="badge bg-primary">{{ stage_data.tool_count if stage_data else 0 }}</span>
                            </td>
                            <td>
                                {% set categories = stage.categories %}
                                <span class="badge bg-secondary">{{ categories.count() if categories else 0 }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tool Categories by Stage -->
    <div class="row mt-4">
        <div class="col-12">
            <h3 class="text-primary mb-3">Tool Categories by Lifecycle Stage</h3>
            <div class="row">
                {% for stage in stages %}
                {% if stage.categories %}
                {% set color = stage_colors[loop.index0 % stage_colors|length] %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100" style="border-left: 4px solid {{ color }};">
                        <div class="card-header" style="background-color: {{ color }}20;">
                            <h6 class="mb-0" style="color: {{ color }};">
                                <strong>{{ stage.position + 1 }}. {{ stage.name }}</strong>
                            </h6>
                        </div>
                        <div class="card-body">
                            {% for category in stage.categories %}
                            <div class="mb-2">
                                <small class="fw-bold">{{ category.name }}</small>
                                <br>
                                <small class="text-muted">{{ category.tools.count() }} tools</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced JavaScript for MaLDReTH interactivity
function focusStage(stageName, stageNumber, toolCount) {
    const message = `MaLDReTH Stage ${stageNumber}: ${stageName}\n\nTools Available: ${toolCount}\n\nThis represents the ${stageName.toLowerCase()} phase of the research data lifecycle.\n\nBased on MaLDReTH deliverable specifications for comprehensive tool mapping.`;
    alert(message);
    
    // Highlight connected stages (simplified version of official interconnections)
    highlightStageConnections(stageNumber);
}

function highlightStageConnections(stageNumber) {
    // Remove any existing highlights
    document.querySelectorAll('.stage-highlight').forEach(el => el.classList.remove('stage-highlight'));
    
    // Add highlight class to current stage
    const currentStage = document.querySelector(`[onclick*="focusStage"][onclick*="${stageNumber}"]`);
    if (currentStage) {
        currentStage.classList.add('stage-highlight');
        
        // Remove highlight after 3 seconds
        setTimeout(() => {
            currentStage.classList.remove('stage-highlight');
        }, 3000);
    }
}

// Add CSS filters for mathematical functions (fallback)
if (typeof Math.cos === 'undefined') {
    // Fallback positions if trigonometry isn't available
    console.log('Using fallback positioning');
}
</script>

<!-- Custom CSS for MaLDReTH Official Visualization -->
<style>
/* Official MaLDReTH visualization styles */
.maldreth-stage {
    transition: all 0.3s ease;
    cursor: pointer;
}

.maldreth-stage:hover {
    transform: scale(1.15) !important;
    filter: brightness(1.2);
}

.stage-highlight {
    animation: pulseHighlight 1s ease-in-out infinite alternate !important;
    border: 6px solid #FFD700 !important;
}

@keyframes pulseHighlight {
    0% { 
        box-shadow: 0 6px 25px rgba(255, 215, 0, 0.6), inset 0 0 0 3px rgba(255, 255, 255, 0.8) !important;
        transform: translate(-50%, -50%) scale(1.1);
    }
    100% { 
        box-shadow: 0 8px 35px rgba(255, 215, 0, 0.9), inset 0 0 0 5px rgba(255, 255, 255, 1) !important;
        transform: translate(-50%, -50%) scale(1.2);
    }
}

/* Responsive adjustments for mobile */
@media (max-width: 768px) {
    .container-fluid {
        padding: 1rem;
    }
    
    .display-4 {
        font-size: 2rem;
    }
    
    /* Adjust stage circles for mobile */
    [style*="width: 70px"] {
        width: 50px !important;
        height: 50px !important;
    }
    
    /* Adjust central circle for mobile */
    [style*="width: 180px"] {
        width: 120px !important;
        height: 120px !important;
    }
}

/* Print styles for academic use */
@media print {
    .alert {
        display: none;
    }
    
    .container-fluid {
        background: white !important;
    }
    
    [style*="background: linear-gradient"] {
        background: #f8f9fa !important;
        border: 2px solid #dee2e6;
    }
}
</style>

{% endblock %}